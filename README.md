# Table of Contents
- [FastAPI-PostgreSQL Microservices Deployment](#fastapi-postgresql-microservices-deployment)
- [Setting Up Your Environment](#setting-up-your-environment)
- [Kubernetes Objects](#kubernetes-objects)
- [Updates in `config/db.py`](#updates-in-configdbpy)
- [Configuration Parameters in `values.yaml`](#configuration-parameters-in-valuesyaml)
- [Environment-Specific Configuration](#environment-specific-configuration)
- [Testing and Validation](#testing-and-validation)
- [Frequently Asked Questions (FAQ)](#frequently-asked-questions-faq)
- [Acknowledgements](#acknowledgements)
- [Authors](#authors)


# üöÄ FastAPI-PostgreSQL Microservices Deployment

This project deploys a Kubernetes infrastructure for a **FastAPI** application and a **PostgreSQL** database. The deployment is managed using **Helm** and **K3s**, a lightweight Kubernetes distribution.

## Setting Up Your Environment

### 1Ô∏è‚É£ Clone the Repository

Before starting, clone the repository containing the necessary files:

```bash
git clone https://github.com/RAPHTER1/kubernetes-datascientest.git
cd kubernetes-datascientest
```

### 2Ô∏è‚É£ Build and Configure the Docker Image

Before deploying, you need to build the Docker image for the FastAPI application. We have optimized the original Python image by using a python-slim version, which reduces the image size and accelerates the deployment process if the image has not been built yet.

#### Build the Image

```bash
cd kubernetes-devops-projet
docker build -t <your-image-name>:<tag> .
```

Alternatively, you can pull the image from Docker Hub instead of building it manually:

```bash
docker pull raphter1/fastapi-app:latest
```

‚ö† **If you do it that way, you will need to set `imagePullPolicy` to `Always` or `IfNotPresent`.** See the [values.yaml configuration](#configuration-parameters-in-valuesyaml) below.

### 3Ô∏è‚É£ Install K3s

We use **K3s with Docker as the container runtime** to allow the deployment of local images without pull errors.

#### Install K3s

```bash
curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644 --docker
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
```

‚ö† **If you use a local image with `imagePullPolicy: Never` or `IfNotPresent`, make sure to add the `--docker` flag when installing K3s. Otherwise, you may encounter `ErrImagePull` or `ImagePullBackOff` errors when creating the pod.**

Additionally, if you do not run the `export KUBECONFIG=/etc/rancher/k3s/k3s.yaml` command, **Helm will fail** with the following error:

```
Error: INSTALLATION FAILED: Kubernetes cluster unreachable
```

This happens because Helm can't find the Kubernetes cluster configuration. You can check if `KUBECONFIG` is set correctly by running:

```bash
echo $KUBECONFIG
```

#### Verify K3s Installation

```bash
kubectl get nodes
```

If everything is set up correctly, you should see an active node.

### 4Ô∏è‚É£ Install Helm

**Helm** is a package manager for Kubernetes that simplifies the deployment and management of applications. For more details, check the official Helm documentation: [Helm Docs](https://helm.sh/docs/).

#### Install Helm

```bash
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
```

#### Verify Helm Installation

```bash
helm version
```

### 5Ô∏è‚É£ Deploying with Helm

Once Helm is installed, you can deploy the Kubernetes infrastructure.

#### Launch the Deployment

```bash
helm install <project-name> <path/to/helm/folder> -f <path/to/values.yaml> -n standard --create-namespace
```

#### Test the Template Before Deployment

Before deploying, you can preview the rendered YAML files generated by Helm:

```bash
helm template <release-name> <chart-path> -f values.yaml
```

#### Check Deployed Pods

After deploying, check if the pods are running correctly:

```bash
kubectl get pods -n standard
```

## Kubernetes Objects

### Overview

This project consists of two main microservices:

- A **FastAPI** application that provides an API for user registration and tracking.
- A **PostgreSQL** database for persistent storage.

These services are deployed on a **Kubernetes cluster** using Helm for easier management and scalability.

| Object Type             | Purpose                                                                |
| ----------------------- | ---------------------------------------------------------------------- |
| **Deployments**         | Manages FastAPI and PostgreSQL containers, ensuring desired replicas.  |
| **Services**            | Exposes FastAPI internally via NodePort and connects it to PostgreSQL. |
| **PersistentVolume**    | Provides persistent storage for PostgreSQL data.                       |
| **ConfigMaps & Secrets**| Stores environment variables and database credentials.                 |

- Currently, **FastAPI is exposed using a NodePort service**. Future improvements will include an **Ingress** to allow a more scalable and secure external exposure.

- **Persistent Storage Note:** Initially, a **PersistentVolumeClaim inside a StatefulSet** was used for PostgreSQL storage. However, for unknown reasons, it did not automatically create a PersistentVolume. As a workaround, a **PersistentVolume was manually defined** to ensure reliable database storage.

## Updates in `config/db.py`

The original `db.py` file in the `kubernetes-devops-project` repository was modified to use environment variables instead of hardcoded database credentials. This change enhances the security and flexibility of the deployment by allowing database connection settings to be managed dynamically through Kubernetes Secrets and ConfigMaps.
To check the new implementation, refer to `kubernetes-devops-project/config/db.py` in repository.

## Configuration Parameters in `values.yaml`

### **Global Parameters**

| Parameter    | Description                | Default Value |
|-------------|--------------------------|---------------|
| `namespace`  | Kubernetes namespace       | `standard`    |
| `environment`| Deployment environment     | `production`  |

### **FastAPI Configuration**

| Parameter               | Description                            | Default Value           |
|------------------------|------------------------------------|-------------------------|
| `fastapi.replicaCount` | Number of replicas for FastAPI     | `3`                     |
| `fastapi.image.repository` | Docker image repository       | `raphter1/fastapi-app`   |
| `fastapi.image.tag`    | Image tag/version                  | `latest`                 |
| `fastapi.image.pullPolicy` | Image pull policy (`Always`, `IfNotPresent`, `Never`) | `IfNotPresent` |
| `fastapi.ports.api.number` | API port inside the container  | `5000`                   |
| `fastapi.ports.api.name` | Name of the port                 | `http`                   |
| `fastapi.service.type`  | Type of service (`NodePort`)      | `NodePort`               |
| `fastapi.service.port`  | Port exposed in the container     | `80`                     |
| `fastapi.service.nodePort` | NodePort for external access  | `32132`                  |

### **PostgreSQL Configuration**

| Parameter                | Description                          | Default Value            |
|-------------------------|----------------------------------|--------------------------|
| `postgres.replicaCount` | Number of replicas for PostgreSQL | `1`                      |
| `postgres.image`        | PostgreSQL image                 | `postgres:12.0-alpine`   |
| `postgres.credentials.user` | Encoded database username    | `YWRtaW4=`                |
| `postgres.credentials.password` | Encoded database password | `cGFzc3dvcmQ=`            |
| `postgres.databaseName` | Name of the database             | `storedb`                 |
| `postgres.hostAuthMethod` | Authentication method         | `trust`                   |
| `postgres.port`         | PostgreSQL service port         | `5432`                    |
| `postgres.service`      | PostgreSQL service name         | `postgres-service`        |
| `postgres.storage.accessModes` | Storage access mode     | `ReadWriteOnce`           |
| `postgres.storage.storageClassName` | Storage class       | `default`                 |
| `postgres.storage.storageSize` | Storage size allocated  | `10Gi`                     |
| `postgres.resources.requests.cpu` | Requested CPU resources | `500m`                  |
| `postgres.resources.requests.memory` | Requested memory resources | `1Gi`              |
| `postgres.resources.limits.cpu` | CPU resource limits     | `2`                        |
| `postgres.resources.limits.memory` | Memory resource limits | `2Gi`                     |


## Environment-Specific Configuration

This project includes different configuration files for different environments:

- **`values-prod.yaml`**: Used for production deployment.
- **`values-stage.yaml`**: Used for staging environment deployment.

You can specify which configuration to use by running Helm with:

```bash
helm install <release-name> <chart-path> -f values-<env>.yaml
```

## Testing and Validation

To ensure everything is working correctly, you can test the microservices using the provided API endpoints.

### **FastAPI API Endpoints**

| Endpoint       | Description                                   |
| -------------- | --------------------------------------------- |
| `/docs`        | Interactive Swagger documentation for testing |
| `/users`       | Retrieves the list of users                   |
| `/users/count` | Returns the total number of registered users  |

You can test these endpoints by navigating to:

```bash
http://<NODE_IP>:<NodePort>/docs
```

where `<NODE_IP>` is the IP of the node running the FastAPI service.

To list all running pods:

```bash
kubectl get pods -n standard
```

To check service details:

```bash
kubectl get svc -n standard
```

## Frequently Asked Questions (FAQ)

### **How do I encode credentials in Base64 for Kubernetes secrets?**
To encode a username or password in Base64, you can use the following command:
```bash
echo -n "your-secret-value" | base64
```
For example, encoding `admin` would look like this:
```bash
echo -n "admin" | base64
# Output: YWRtaW4=
```
Make sure to use the `-n` flag to avoid including a newline character.

### **Why does my PersistentVolumeClaim (PVC) not create a PersistentVolume (PV)?**
If your PVC does not automatically bind to a PV, check the following:
- Ensure a matching **StorageClass** exists.
- Verify that dynamic volume provisioning is supported in your Kubernetes cluster.
- Manually create a **PersistentVolume** if automatic binding fails.

### **How do I check the logs of a running pod?**
To view the logs of a specific pod, use:
```bash
kubectl logs <pod-name> -n standard
```
If the pod has multiple containers, specify the container name:
```bash
kubectl logs <pod-name> -c <container-name> -n standard
```

### **How do I restart a pod in Kubernetes?**
Pods cannot be restarted directly. You must delete the pod and let the **Deployment** recreate it:
```bash
kubectl delete pod <pod-name> -n standard
```

### **How do I list all services in my namespace?**
Use the following command to check all services:
```bash
kubectl get svc -n standard
```

### **Why is my FastAPI service not accessible?**
If your service is not accessible:
- Check if the service is correctly exposed using:
```bash
kubectl get svc -n standard
```
- Verify that the correct **NodePort** is assigned:
```bash
kubectl describe svc <service-name> -n standard
```
- Ensure that the Kubernetes node's firewall allows traffic on the assigned port.

### **How do I scale my FastAPI application?**
To increase the number of replicas:
```bash
kubectl scale deployment fastapi-deployment --replicas=5 -n standard
```

## Acknowledgements

 - [Awesome Readme Templates](https://awesomeopensource.com/project/elangosundar/awesome-README-templates)
 - [Awesome README](https://github.com/matiassingers/awesome-readme)
 - [How to write a Good readme](https://bulldogjob.com/news/449-how-to-write-a-good-readme-for-your-github-project)

## Authors

- [@RAPHTER1](https://www.github.com/RAPTHER1)
